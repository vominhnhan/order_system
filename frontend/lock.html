<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kh√≥a B√†n - Wave Cafe</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
    />
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div id="lockScreen" class="lock-container">
      <h2 class="tm-text-primary text-center mb-4">üîí M·ªü kh√≥a b√†n</h2>

      <div class="form-group">
        <label for="tableSelect">Ch·ªçn b√†n:</label>
        <select id="tableSelect" class="form-control">
          <option value="">Ch·ªçn s·ªë b√†n...</option>
          <!-- Danh s√°ch b√†n s·∫Ω ƒë∆∞·ª£c ƒë·ªï ƒë·ªông t·ª´ API -->
        </select>
      </div>

      <div class="form-group">
        <label for="secretCodeInput">Nh·∫≠p Secret Code:</label>
        <input
          type="password"
          id="secretCodeInput"
          class="form-control"
          placeholder="Nh·∫≠p m√£ x√°c nh·∫≠n"
        />
        <p id="errorMsg" class="text-danger mt-2" style="display: none">
          M√£ ho·∫∑c s·ªë b√†n kh√¥ng ƒë√∫ng!
        </p>
      </div>

      <button id="unlockTableBtn" class="btn btn-primary btn-block">
        M·ªü kh√≥a
      </button>
    </div>

    <style>
      body {
        font-family: Arial, sans-serif;
        background: url("img/lockscreen.jpg") no-repeat center center fixed;
        background-size: cover;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }
      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        z-index: 1;
      }
      .lock-container {
        width: 350px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
        text-align: center;
        position: relative;
        z-index: 2;
      }
      .tm-text-primary {
        color: #007bff;
      }
    </style>

    <script>
      $(document).ready(function () {
        loadTables(); // Load danh s√°ch b√†n khi trang load

        $("#unlockTableBtn").click(function () {
          let selectedTable = $("#tableSelect").val();
          let secretCode = $("#secretCodeInput").val();

          if (!selectedTable || !secretCode) {
            $("#errorMsg")
              .text("Vui l√≤ng ch·ªçn b√†n v√† nh·∫≠p m√£ x√°c nh·∫≠n!")
              .show();
            return;
          }

          // G·ª≠i request POST ƒë·∫øn API /api/table/open v·ªõi table_id v√† secret_code
          $.ajax({
            url: "http://localhost:3002/api/table/open",
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: "Bearer " + localStorage.getItem("token"),
            },
            data: JSON.stringify({
              table_id: selectedTable,
              secret_code: secretCode,
            }),
            success: function (response) {
              console.log("Open table response:", response);
              if (response.status === "success") {
                // L∆∞u table id v√† order id v√†o sessionStorage
                sessionStorage.setItem("tableNumber", selectedTable);
                // D·ª±a theo c·∫•u tr√∫c tr·∫£ v·ªÅ, n·∫øu server tr·∫£ v·ªÅ key "metaData.order.id"
                sessionStorage.setItem("order_id", response.metaData.order.id);
                // Chuy·ªÉn h∆∞·ªõng sang trang waiter (v√≠ d·ª•: waiter.html ho·∫∑c index.html)
                window.location.href = "waiter.html";
              } else {
                $("#errorMsg")
                  .text(response.message || "M√£ ho·∫∑c s·ªë b√†n kh√¥ng ƒë√∫ng!")
                  .show();
              }
            },
            error: function (err) {
              console.error("L·ªói m·ªü kh√≥a b√†n:", err);
              $("#errorMsg").text("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!").show();
            },
          });
        });
      });

      // H√†m loadTables(): g·ªçi API GET /api/tables v√† ƒë·ªï danh s√°ch b√†n v√†o <select>
      function loadTables() {
        $.ajax({
          url: "http://localhost:3002/api/tables",
          method: "GET",
          headers: {
            Authorization: "Bearer " + localStorage.getItem("token"),
          },
          success: function (response) {
            console.log("Tables response:", response);
            if (response.status === "success") {
              // S·ª≠ d·ª•ng key ph√π h·ª£p: n·∫øu server tr·∫£ v·ªÅ "metadata", d√πng response.metadata
              const tables = response.metaData || response.data;
              const $tableSelect = $("#tableSelect");
              $tableSelect.empty();
              $tableSelect.append('<option value="">Ch·ªçn s·ªë b√†n...</option>');
              tables.forEach(function (table) {
                // N·∫øu c·∫ßn l·ªçc theo tr·∫°ng th√°i AVAILABLE
                if (table.status === "AVAILABLE") {
                  $tableSelect.append(`
                    <option value="${table.id}">
                      ${table.table_name}
                    </option>
                  `);
                }
              });
            } else {
              console.error("Kh√¥ng th·ªÉ load b√†n:", response.message);
            }
          },
          error: function (err) {
            console.error("L·ªói AJAX load tables:", err);
          },
        });
      }
    </script>
  </body>
</html>
